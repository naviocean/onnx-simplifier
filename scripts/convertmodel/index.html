<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript">
            window.onload = () => {
                const worker = new Worker("worker.js");
                const log_output = document.getElementById("log-output");
                const input = document.getElementById("file-input");
                const dl_btn = document.getElementById("download-button");
                let result_name = "";
                worker.onmessage = (e) => {
                    switch (e.data[0]) {
                        case "stdout":
                            log_output.textContent += e.data[1] + "\n";
                            break;
                        case "stderr":
                            log_output.textContent += e.data[1] + "\n";
                            break;
                        case "convert-done":
                            input.disabled = false;
                            dl_btn.disabled = false;
                            const data_url = e.data[1];
                            dl_btn.onclick = () => {
                                const a = document.createElement("a");
                                a.href = data_url;
                                a.download = result_name;
                                a.click();
                            };
                            break;
                    }
                };

                input.addEventListener("change", async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    result_name = (file.name.endsWith(".onnx") ? file.name.substring(0, file.name.length - 5) : file.name) + ".simplified.onnx"

                    input.disabled = true;
                    dl_btn.disabled = true;
                    const buf = await file.arrayBuffer();
                    console.log("sending: ", file.name);
                    worker.postMessage(["input", buf], [buf]);
                });
            };
        </script>
    </head>
    <body>
        <h1>Model converter</h1>
        <input type="file" id="file-input" />
        <button id="download-button" disabled>Download</button>
        <h2>Console outputs:</h2>
        <pre id="log-output"></pre>
    </body>
</html>
